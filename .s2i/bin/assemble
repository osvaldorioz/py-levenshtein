#!/bin/bash
set -e
set -x  # Enable debug output

# Version 1.1 for Levenshtein project

# Ensure required commands are available
command -v g++ >/dev/null 2>&1 || { echo "g++ is not installed"; exit 1; }
command -v python3 >/dev/null 2>&1 || { echo "python3 is not installed"; exit 1; }
command -v file >/dev/null 2>&1 || { echo "file is not installed"; exit 1; }
command -v python3-config >/dev/null 2>&1 || { echo "python3-config is not installed"; exit 1; }

# Check for Python.h to verify python3-devel is installed
if [ ! -f "/usr/include/python3.12/Python.h" ]; then
    echo "Error: Python.h not found. Ensure python3-devel is installed in the builder image."
    exit 1
fi

# Change to source directory
cd /tmp/src

# List contents of /tmp/src for debugging
echo "Contents of /tmp/src:"
ls -la /tmp/src

# Copy Python files to /opt/app-root/src
echo "Copying .py files to /opt/app-root/src/"
cp -v /tmp/src/*.py /opt/app-root/src/ || echo "No .py files found in /tmp/src"

# Copy requirements.txt if exists
if [ -f /tmp/src/requirements.txt ]; then
    echo "Copying requirements.txt to /opt/app-root/src/"
    cp -v /tmp/src/requirements.txt /opt/app-root/src/
    echo "Installing Python dependencies..."
    pip install --no-cache-dir -r /opt/app-root/src/requirements.txt
fi

# Compile levdes.so
echo "Compiling levdes.so..."
g++ -O3 -Wall -shared -std=c++14 -fPIC $(python3 -m pybind11 --includes) \
    /tmp/src/binding.cpp /tmp/src/levenshtein_core.cpp \
    -o /opt/app-root/src/levdes$(python3-config --extension-suffix) \
    -I/usr/include/python3.12 \
    -L/opt/app-root/lib64 \
    -L/usr/lib64 \
    -std=c++11 \
    || { echo "Error compiling levdes.so"; exit 1; }

# Set permissions for /opt/app-root/src
chown -R 1001:0 /opt/app-root/src
chmod -R g+rw /opt/app-root/src

echo "Assemble completed successfully."
